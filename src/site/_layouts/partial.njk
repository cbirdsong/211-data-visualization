{% set css %}
{% include "css/main.css" %}
{% endset %}
<section class="lifeline">
  <style>
    {{css | safe}}
  </style>
  <div class="lifeline-wrapper" data-lifeline-active-category="intro">
    <header class="lifeline-header">
      <nav class="lifeline-nav" aria-label="Main Menu">
        {% include "nav-links.njk" %}
      </nav>
    </header>

    <div class="lifeline-intro-wrapper">
      {% for category in categories %}
        {% for summary in summaries %}
          {% if summary.category == category.name %}
            <div class="lifeline-intro category-{{ category.slug }}" data-lifeline-category="{{ category.slug }}" data-lifeline-active-category="intro" id="{{category.slug}}">
              <div class="lifeline-intro-inner">
                <div class="lifeline-intro-title">
                  <h2>{{ category.name }}</h2>
                </div>
                <div class="lifeline-intro-text">
                  <p>{{ summary.text }}</p>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>

    <div class="lifeline-column-wrapper">
      <main class="lifeline-column column-card">
        <div class="cards">
          {%- for category in categories -%}
            <section class="category category-{{ category.slug }}" data-lifeline-category="{{ category.slug }}" data-lifeline-active-category="intro">
              <div class="card-group">
                {%- for item in entries -%}
                  {%- if item.category == category.name or item.category == "All" -%}
                    {% include "card-" ~ item.type ~ ".njk" %}
                  {%- endif -%}
                {%- endfor -%}
              </div>
            </section>
          {%- endfor -%}
        </div>
      </main>
      <div class="lifeline-column column-graph">
        <div class="graph" style="--ll-count-total: {{ stat_totals.largest }}">
          {%- for item in stats -%}
            <div class="line" data-date="{{ item.date_num }}">
              <div class="line__date line__text">
                <span class="date">{{ item.date_short }}</span>
                <strong class="day">{{ item.day | truncate(1, true, "") }}</strong>
              </div>
              {% for category in categories %}
                {% if category.slug == "health" %}
                  {% set amount = item.health %}
                {% endif %}
                {% if category.slug == "food" %}
                  {% set amount = item.food %}
                {% endif %}
                {% if category.slug == "housing" %}
                  {% set amount = item.housing %}
                {% endif %}
                {% if category.slug == "financial" %}
                  {% set amount = item.financial %}
                {% endif %}
                <div class="line__display category-{{ category.slug }}" style="--ll-count: {{ amount }};" data-count="{{ amount }}" data-lifeline-category="{{ category.slug }}" data-lifeline-active-category="intro">
                  <span class="visually-hidden">
                    {{ category.name }}:
                    {{ amount }}
                    Calls
                  </span>
                </div>
              {%- endfor -%}
            </div>
          {%- endfor -%}
        </div>
      </div>
    </div>

    <footer class="lifeline-footer">
      <nav class="lifeline-nav" aria-label="Categories">
        {% include "nav-links.njk" %}
      </nav>
    </footer>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/ScrollTrigger.min.js"></script>

  <script>
    function setActiveCategory(category) {
      document
        .querySelectorAll('[data-lifeline-category].active')
        .forEach(function (item) {
          item
            .classList
            .remove("active");

        });
      document
        .querySelectorAll('[data-lifeline-category="' + category + '"]')
        .forEach(function (item) {
          item
            .classList
            .add("active");
        });
      document
        .querySelectorAll('[data-lifeline-active-category]')
        .forEach(function (item) {
          item.dataset.lifelineActiveCategory = category;
        });
    }

    document
      .querySelectorAll('a[href][data-lifeline-category]')
      .forEach(function (button) {
        button.addEventListener('click', function (event) {
          setActiveCategory(event.target.dataset.lifelineCategory);
        });
      });
    if (window.location.hash) {
      setActiveCategory(window.location.hash.replace('#', ''));
    }

    var graph_height = document
      .querySelector('.graph')
      .getBoundingClientRect();
    var cards_height = document
      .querySelector('.card-group')
      .getBoundingClientRect();

    console.log('.graph: ');
    console.log(graph_height.height);
    console.log('.card-group: ');
    console.log(cards_height.height);

    var triggering_column = '.graph';
    var scrolling_column = '.card-group';

    gsap.to(scrolling_column, {
      //yPercent: 50,
      y: function (index, target, targets) { //function-based value
        var target_dimensions = target.getBoundingClientRect();
        var parent_dimensions = target
          .parentNode
          .getBoundingClientRect();
        var distance = parent_dimensions.bottom - target_dimensions.height;

        if (window.innerWidth > 768) {
          return parent_dimensions.bottom - target_dimensions.height;
        } else {
          return parent_dimensions.height - target_dimensions.height;
        }
      },
      ease: 'none',
      scrollTrigger: {
        trigger: triggering_column,
        start: 'top 30%',
        end: 'bottom 0%',
        scrub: 0.1
      }
    });
  </script>
</section>